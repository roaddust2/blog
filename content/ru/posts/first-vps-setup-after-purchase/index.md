---
title: '[Инфраструктура] Первая настройка VPS после покупки'
description: Рассказываю как я настраиваю свежий сервер под Ubuntu 22.04
slug: pervaya-nastroika-vps-posle-pokupki

categories: ["Infrastructure"]
tags: ["VPS", "Server", "Ubuntu 22.04"]

date: 2024-03-31T12:56:19+07:00
draft: false

cover:
  image: "cover.jpg"
  alt: "Мем про VPS: Низкий IQ-ставлю все на VPS; Средний IQ-Serverless/Lambdas/etc.; Высокий IQ-ставлю все на VPS"
  relative: true
---

## Вступление
> :v: Мнение автора может отличаться от вашего и это нормально

Первый пост решил посвятить настройке VPS (Virtual private server). Думаю не стоит долго объяснять что это и для чего оно нужно, ~~конечно, чтобы поднять свой Майнкрафт сервер и поставить ВЕПЕЕН~~. Задач может быть много, хостить статику, какие-то приложения, запускать контейнеры, или просто практиковаться в админстве, но настройка плюс минус одинаковая. 

Но что сделать, чтобы сервер был минимально устойчив к неправомерному доступу, и на него не поставили 100500 майнеров? Сейчас покажу как это делаю я. В качестве ОС Ubuntu 22.04, приступим.

## Первым делом
Для начала я подключаюсь к серверу по лог/пассам, которые выдал хостинг и стягиваю последние обновления:

```bash
ssh root@your_server_ip
```

```bash
apt update
apt upgrade
```

Возможно потребуется ребут, выполнить его можно одной командой, после чего авторизоваться повторно:

```bash
reboot
```

Работать под рутом не очень безопасно, поэтому надо создать пользователя. Создаем пользователя с именем "admin". Задаем ему пароль, остальное по желанию, делегируем права администратора (sudo).

```bash 
adduser admin
usermod -aG sudo admin
```

## Секьюрность

Чтобы слегка защитить наш сервер я делаю три вещи:
- Настраиваю SSH ключи
- Запрещаю авторизацию по паролю
- Настраиваю фаервол, в нашем случае ufw

### SSH Ключи
  
Начнем с SSH, он необходим, чтобы в дальнейшем на сервер можно было заходить с машины с доверенным сертификатом, плюсом идет отсутствие необходимости каждый раз вводить пароль.

Переходим в локальную машину и генерируем пару ключей.
Флаг -t задает тип ключа, я выбираю "ed25519", а -f позволяет нам выбрать директорию куда поместить пару и название ключа. Поле "Enter passphrase" оставляю пустым. 

```bash
ssh-keygen -t ed25519 -f ~/.ssh/vps
```

Отправляем созданный ключ на сервер для пользователя root с помощью утилиты "ssh-copy-id". Флаг -i необходим для выбора конкретного ключа. Для чего нужен флаг -o? Неочевидно, но при попытке добавить ключ на сервер, ssh-copy-id пытается залогиниться на сервере так же с помощью ключа, хотя он еще не установлен, это приводит к ошибке "Too many authentication failures". Поэтому используем флаг для авторизации по паролю.

```bash
ssh-copy-id -i ~/.ssh/vps -o PubKeyAuthentication=no root@your_server_ip
```

Проверяем все ли работает (если не запросит пароль, все ок):

```bash
ssh root@your_server_ip
```

Да, теперь мы можем заходить на сервер без пароля. Добавляем ключ для нашего пользователя "admin", я это делаю через rsync (не забываем установить владельца и группу admin:admin). Выходим.

```bash
apt install rsync
rsync --archive --chown=admin:admin ~/.ssh /home/admin
exit
```

### Запрет авторизации по паролю

> :warning: Перед тем как идти дальше, убедитесь, что можете попасть на сервер без пароля по SSH ключу, иначе вы утратите доступ до своей VPS! Ну все предупредил, идем дальше.

Чтобы пароль нельзя было подобрать, а авторизация была доступна только по SSH ключам, необходимо отключить возможность авторизоваться по паролю. Логично? Логично.

Логинимся через нашего пользователя. На этом моменте пароль уже не запрашивается, ведь мы добавили ключи ранее.

```bash
ssh admin@your_server_ip
```

Открываем sshd_config:

```
sudo nano /etc/ssh/sshd_config
```

Меняем следующие строки с yes на no:

```
PasswordAuthentication no
UsePAM no
PermitRootLogin no
```

Перезапускаем сервис ssh, чтобы изменения вступили в силу:

```bash
sudo systemctl reload ssh
```

### Фаервол ufw

Ставим все нужные проги, я обойдусь прокси сервером и certbot для установки сертификатов Let's Encrypt. Так же устанавливаем сам фаервол.

```bash
sudo apt install nginx certbot python3-certbot-nginx
sudo apt install ufw
```

Теперь добавим правила в наш фаервол ufw (обертка над ip tables). Мы хотим запретить на вход все кроме доступа по SSH, так же раздаем доступ Nginx.

Проверяем работает ли ufw:

```bash
sudo ufw status
```

Должно быть так:

```bash
Status: inactive
```

Раздаем доступы и запускаем наш фаервол:

```bash
sudo ufw allow OpenSSH
sudo ufw allow "Nginx Full"
sudo ufw enable
```

```bash
Command may disrupt existing ssh connections. Proceed with operation (y|n)? # Соглашаемся
Firewall is active and enabled on system startup
```

Проверяем доступы:

```bash
sudo ufw status
```

```bash
Status: active

To                         Action      From
--                         ------      ----
OpenSSH                    ALLOW       Anywhere                  
Nginx Full                 ALLOW       Anywhere                  
OpenSSH (v6)               ALLOW       Anywhere (v6)             
Nginx Full (v6)            ALLOW       Anywhere (v6)             
```

Теперь нам доступно только SSH подключение и доступ через интернет по порту 80 `http://your_server_ip/`, там будет приветственная страничка nginx.

Готово!
